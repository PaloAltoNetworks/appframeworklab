{
	"AWSTemplateFormatVersion": "2010-09-09",
	"Description": "Palo Alto Networks AppFramework Lab Setup",
	"Metadata": {
		"AWS::CloudFormation::Interface": {
			"ParameterGroups": [
				{
					"Label": {
						"default": "Advanced Configuration - General"
					},
					"Parameters": [
                        "keyPairPrefix"
                    ]
                }	
            ],	
			"ParameterLabels": {
                "keyPairPrefix": {
                    "default": "EC2 KeyPair Prefix"
                }
			}
		}
	},
	"Parameters": {
        "keyPairPrefix": {
            "Description": "EC2 Panorama/NGFW Key Pair Prefix",
            "Type": "String",
            "Default": "panw-appframework"
        }
    },
    "Resources": {
        "LambdaEC2Role": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version" : "2012-10-17",
                    "Statement": [{
                        "Effect": "Allow",
                        "Principal": {
                            "Service": [ "lambda.amazonaws.com" ]
                        },
                        "Action": [ "sts:AssumeRole" ]
                    }]
                },
                "ManagedPolicyArns": [
                    { "Ref": "EC2KeyPairPolicy" },
                    { "Ref": "LambdaExecutionPolicy"}
                ]
            }
        },

        "EC2HandleKeysFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "Code": {
                    "S3Bucket": "appframeworklab-lambdas",
                    "S3Key": "lambdas.zip"
                },
                "Description": "Handle EC2 KeyPair",
                "Handler": "index.handleKeyPair",
                "Role": {"Fn::GetAtt" : [ "LambdaEC2Role", "Arn" ] },
                "Runtime": "nodejs8.10",
                "Timeout": 30
            },
            "DependsOn": [
                "LambdaEC2Role"
            ]
        },

        "handleKeyPair": {
            "Type": "Custom::handleKeyPair",
            "Properties": {
                "ServiceToken": { "Fn::GetAtt" : ["EC2HandleKeysFunction", "Arn"] },
                "keyName": {"Ref": "keyPairPrefix"},
                "stackName": { "Ref": "AWS::StackName" },
                "targetBucket": { "Ref": "ConfigBucket"},
                "keyPath": {"Ref": "configBucketKeyPath" }
            },
            "DependsOn": [
                "ConfigBucket",
                "EC2HandleKeysFunction",
                "cloneConfigBucket"
            ]
        },

        "EC2KeyPairPolicy": {
            "Type": "AWS::IAM::ManagedPolicy",
            "Properties": {
                "Description" : "EC2 KeyPair Creation Policy",
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Action": "ec2:CreateKeyPair",
                            "Resource": "*"
                        },
                        {
                            "Effect": "Allow",
                            "Action": "ec2:DeleteKeyPair",
                            "Resource": "*"
                        }
                    ]
                }
            }
        },
        "LambdaExecutionPolicy": {
            "Type": "AWS::IAM::ManagedPolicy",
            "Properties": {
                "Description" : "Lambda Execution Policy",
                "PolicyDocument" : {
                    "Version" : "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Action": [
                                "logs:CreateLogGroup",
                                "logs:CreateLogStream",
                                "logs:PutLogEvents"
                            ],
                            "Resource": "arn:aws:logs:*:*:*"
                        }
                    ]
                }
            }
        }
 
    },
    "Outputs": {
        "CreatedKeyPair": {
            "Description": "Created EC2 Key Pair",
            "Value": { "Fn::GetAtt": ["handleKeyPair", "keyPair"]}
        }
    }
}
