{
	"AWSTemplateFormatVersion": "2010-09-09",
	"Description": "Palo Alto Networks AppFramework Lab Setup",
	"Metadata": {
		"AWS::CloudFormation::Interface": {
			"ParameterGroups": [
				{
					"Label": {
						"default": "Basic Configuration - REQUIRED"
					},
					"Parameters": [
                        "company",
                        "authCode",
                        "apiKey",
                        "ConfigureRoute53"
					]
				},
				{
					"Label": {
						"default": "Advanced Configuration - General"
					},
					"Parameters": [
                        "sourceNgfwBucket",
                        "sourceConfigBucket",
                        "keyPairPrefix",
                        "configBucketKeyPath",
                        "ngfwBucketAuthCodeKey",
                        "ngfwBucketPrefix",
                        "configBucketPrefix"
                    ]
                }	
            ],	
			"ParameterLabels": {
                "company": {
                    "default": "Company"
                },
                "sourceNgfwBucket": {
                    "default": "Source NGFW Bucket"
                },
                "sourceConfigBucket": {
                    "default": "Source Conf Bucket"
                },
                "apiKey": {
                    "default": "DNS AutoConfig API Key"
                },
                "authCode": {
                    "default": "NGFW Auth Code"
                },
                "keyPairPrefix": {
                    "default": "EC2 KeyPair Prefix"
                },
                "configBucketKeyPath": {
                    "default": "Conf Bucket Private Key Path"
                },
                "ngfwBucketAuthCodeKey": {
                    "default": "NGFW Bucket AuthCode Key"
                },
                "ngfwBucketPrefix": {
                    "default": "Target NGFW Bucket"
                },
                "configBucketPrefix": {
                    "default": "Target Config Bucket Name"
                },
				"ConfigureRoute53": {
					"default": "Configure Route53"
				}
			}
		}
	},
	"Parameters": {
		"company": {
			"Description": "DNS Subdomain name (alphanum, no spaces)",
			"Type": "String"
        },
        "sourceNgfwBucket": {
            "Description": "Source Bucket for NGFW Bootstrap",
            "Type": "String",
            "Default": "applicationframework-ngfw"
        },
        "sourceConfigBucket": {
            "Description": "Source Bucket for Lab Configuration",
            "Type": "String",
            "Default": "applicationframework-conf"
        },
        "apiKey": {
            "Description": "DNS Automatic Configuration API Key",
            "Type": "String",
			"NoEcho": "true"
        },
        "authCode": {
            "Description": "NGFW Authorization Code (VM-100)",
            "Type": "String"
        },
        "keyPairPrefix": {
            "Description": "EC2 Panorama/NGFW Key Pair Prefix",
            "Type": "String",
            "Default": "panw-appframework"
        },
        "configBucketKeyPath": {
            "Description": "Lab Configuration bucket Private Key Path (dir path only)",
            "Type": "String",
            "Default": "keys"
        },
        "ngfwBucketAuthCodeKey": {
            "Description": "NGFW Bucket Authcode Key (fullfile path)",
            "Type": "String",
            "Default": "license/authcodes"
        },
        "ngfwBucketPrefix": {
            "Description": "Target NGFW Bucket Name Prefix",
            "Type": "String",
            "Default": "panw-appf-ngfw"      
        },
        "configBucketPrefix": {
            "Description": "Target Config Bucket Name Prefix",
            "Type": "String",
            "Default": "panw-appf-conf"
        },
		"ConfigureRoute53": {
			"AllowedValues": [
				"true",
				"false"
			],
			"Default": "true",
			"Description": "Dynamically Configure Route53 Hosted Zone",
			"Type": "String"
		}
    },
	"Conditions" : {
		"ConfRoute53" : {"Fn::Equals" : [{"Ref" : "ConfigureRoute53"}, "true"]}
	},
    "Resources": {
        "LambdaS3Role": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version" : "2012-10-17",
                    "Statement": [{
                        "Effect": "Allow",
                        "Principal": {
                            "Service": [ "lambda.amazonaws.com" ]
                        },
                        "Action": [ "sts:AssumeRole" ]
                    }]
                },
                "ManagedPolicyArns": [
                    { "Ref": "S3WritePolicy" },
                    { "Ref": "LambdaExecutionPolicy"}
                ]
            }
        },
        "LambdaEC2Role": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version" : "2012-10-17",
                    "Statement": [{
                        "Effect": "Allow",
                        "Principal": {
                            "Service": [ "lambda.amazonaws.com" ]
                        },
                        "Action": [ "sts:AssumeRole" ]
                    }]
                },
                "ManagedPolicyArns": [
                    { "Ref": "EC2KeyPairPolicy" },
                    { "Ref": "S3WritePolicy" },
                    { "Ref": "LambdaExecutionPolicy"}
                ]
            }
        },
        "LambdaR53Role": {
            "Type": "AWS::IAM::Role",
            "Condition" : "ConfRoute53",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version" : "2012-10-17",
                    "Statement": [{
                        "Effect": "Allow",
                        "Principal": {
                            "Service": [ "lambda.amazonaws.com" ]
                        },
                        "Action": [ "sts:AssumeRole" ]
                    }]
                },
                "ManagedPolicyArns": [
                    { "Ref": "R53GetHostedZonePolicy" },
                    { "Ref": "LambdaExecutionPolicy"}
                ]
            }
        },

        "S3PopulateBucketFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "Code": {
                    "S3Bucket": "appframeworklab-lambdas",
                    "S3Key": "lambdas.zip"
                },
                "Description": "Populate S3 Bucket",
                "Handler": "index.handleS3Bucket",
                "Role": {"Fn::GetAtt" : [ "LambdaS3Role", "Arn" ] },
                "Runtime": "nodejs8.10",
                "Timeout": 300
            },
            "DependsOn": [
                "LambdaS3Role"
            ]
        },

        "S3WriteAuthCodeFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "Code": {
                    "S3Bucket": "appframeworklab-lambdas",
                    "S3Key": "lambdas.zip"
                },
                "Description": "Populate S3 Bucket",
                "Handler": "index.writeAuthCode",
                "Role": {"Fn::GetAtt" : [ "LambdaS3Role", "Arn" ] },
                "Runtime": "nodejs8.10",
                "Timeout": 30
            },
            "DependsOn": [
                "LambdaS3Role"
            ]
        },

        "RegisterDNSFunction": {
            "Type": "AWS::Lambda::Function",
            "Condition" : "ConfRoute53",
            "Properties": {
                "Code": {
                    "S3Bucket": "appframeworklab-lambdas",
                    "S3Key": "lambdas.zip"
                },
                "Description": "Register DNS subdomain in appframework.rocks",
                "Handler": "index.getRoute53",
                "Role": {"Fn::GetAtt" : [ "LambdaR53Role", "Arn" ] },
                "Runtime": "nodejs8.10",
                "Timeout": 30
            },
            "DependsOn": [
                "LambdaR53Role"
            ]
        },

        "EC2HandleKeysFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "Code": {
                    "S3Bucket": "appframeworklab-lambdas",
                    "S3Key": "lambdas.zip"
                },
                "Description": "Handle EC2 KeyPair",
                "Handler": "index.handleKeyPair",
                "Role": {"Fn::GetAtt" : [ "LambdaEC2Role", "Arn" ] },
                "Runtime": "nodejs8.10",
                "Timeout": 30
            },
            "DependsOn": [
                "LambdaEC2Role"
            ]
        },

        "registerDNS": {
            "Type": "Custom::RunRegisterDNS",
            "Condition" : "ConfRoute53",
            "Properties": {
                "ServiceToken": { "Fn::GetAtt" : ["RegisterDNSFunction", "Arn"] },
                "company": {"Ref": "company"},
                "apiKey": { "Ref": "apiKey"},
                "DNSZone": {"Ref": "DNSZone" }
            },
            "DependsOn": [
                "DNSZone",
                "RegisterDNSFunction"
            ]
        },

        "writeAuthCode": {
            "Type": "Custom::writeAuthCode",
            "Properties": {
                "ServiceToken": { "Fn::GetAtt" : ["S3WriteAuthCodeFunction", "Arn"] },
                "keyName": {"Ref": "ngfwBucketAuthCodeKey"},
                "targetBucket": { "Ref": "NGFWBucket"},
                "authCode": {"Ref": "authCode" }
            },
            "DependsOn": [
                "NGFWBucket",
                "S3WriteAuthCodeFunction",
                "cloneNGFWBucket"
            ]
        },

        "handleKeyPair": {
            "Type": "Custom::handleKeyPair",
            "Properties": {
                "ServiceToken": { "Fn::GetAtt" : ["EC2HandleKeysFunction", "Arn"] },
                "keyName": {"Ref": "keyPairPrefix"},
                "stackName": { "Ref": "AWS::StackName" },
                "targetBucket": { "Ref": "ConfigBucket"},
                "keyPath": {"Ref": "configBucketKeyPath" }
            },
            "DependsOn": [
                "ConfigBucket",
                "EC2HandleKeysFunction",
                "cloneConfigBucket"
            ]
        },

        "cloneNGFWBucket": {
            "Type": "Custom::cloneNGFWBucket",
            "Properties": {
                "ServiceToken": { "Fn::GetAtt" : ["S3PopulateBucketFunction", "Arn"] },
                "sourceBucket": {"Ref": "sourceNgfwBucket"},
                "targetBucket": { "Ref": "NGFWBucket"}
            },
            "DependsOn": [
                "ConfigBucket",
                "S3PopulateBucketFunction"
            ]
        },

        "cloneConfigBucket": {
            "Type": "Custom::cloneNGFWBucket",
            "Properties": {
                "ServiceToken": { "Fn::GetAtt" : ["S3PopulateBucketFunction", "Arn"] },
                "sourceBucket": {"Ref": "sourceConfigBucket"},
                "targetBucket": { "Ref": "ConfigBucket"}
            },
            "DependsOn": [
                "ConfigBucket",
                "S3PopulateBucketFunction"
            ]
        },

        "EC2KeyPairPolicy": {
            "Type": "AWS::IAM::ManagedPolicy",
            "Properties": {
                "Description" : "EC2 KeyPair Creation Policy",
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Action": "ec2:CreateKeyPair",
                            "Resource": "*"
                        },
                        {
                            "Effect": "Allow",
                            "Action": "ec2:DeleteKeyPair",
                            "Resource": "*"
                        }
                    ]
                }
            }
        },
        "LambdaExecutionPolicy": {
            "Type": "AWS::IAM::ManagedPolicy",
            "Properties": {
                "Description" : "Lambda Execution Policy",
                "PolicyDocument" : {
                    "Version" : "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Action": [
                                "logs:CreateLogGroup",
                                "logs:CreateLogStream",
                                "logs:PutLogEvents"
                            ],
                            "Resource": "arn:aws:logs:*:*:*"
                        }
                    ]
                }
            }
        },
        "R53GetHostedZonePolicy": {
            "Type": "AWS::IAM::ManagedPolicy",
            "Condition" : "ConfRoute53",
            "Properties": {
                "Description" : "Lambda Execution Policy",
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Action": "route53:GetHostedZone",
                            "Resource": { 
                                "Fn::Sub" : [
                                    "arn:aws:route53:::hostedzone/${zoneid}",
                                    { "zoneid" : { "Ref": "DNSZone" }}
                                ]
                            }
                        }
                    ]
                }
            },
            "DependsOn": [
                "DNSZone"
            ]
        },
        "S3WritePolicy": {
            "Type": "AWS::IAM::ManagedPolicy",
            "Properties": {
                "Description" : "S3 List and Write Policy",
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Action": "s3:ListBucket",
                            "Resource": "arn:aws:s3:::*"
                        },
                        {
                            "Effect": "Allow",
                            "Action": [
                                "s3:ListAllMyBuckets",
                                "s3:HeadBucket"
                            ],
                            "Resource": "*"
                        },
                        {
                            "Effect": "Allow",
                            "Action": [
                                "s3:ListBucket",
                                "s3:PutObject",
                                "s3:PutObjectAcl",
                                "s3:DeleteObject"
                            ],
                            "Resource": [
                                { "Fn::GetAtt" : [ "ConfigBucket", "Arn"] },
                                { "Fn::Join" : [ 
                                    "", [
                                    { "Fn::GetAtt" : [ "ConfigBucket", "Arn"] },
                                    "/*" ]
                                ]},
                                { "Fn::GetAtt" : [ "NGFWBucket", "Arn"] },
                                { "Fn::Join" : [ 
                                    "", [
                                    { "Fn::GetAtt" : [ "NGFWBucket", "Arn"] },
                                    "/*" ]
                                ]}
                            ]
                        }                       
                    ]
                }
            },
            "DependsOn": [
                "NGFWBucket",
                "ConfigBucket"
            ]
        },
        "NGFWBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": [ 
                        "${prefix}-${AWS::StackName}",
                        { "prefix": {"Ref": "ngfwBucketPrefix"}}
                    ]
                }
            },
            "DeletionPolicy": "Delete"
        },
        "ConfigBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": [ 
                        "${prefix}-${AWS::StackName}",
                        { "prefix": {"Ref": "configBucketPrefix"}}
                    ]
                }
            },
            "DeletionPolicy": "Delete"
        },
        "DNSZone" : {
            "Type" : "AWS::Route53::HostedZone",
            "Condition" : "ConfRoute53",
            "Properties": {
                "HostedZoneConfig": {
                  "Comment": "Application Framework Hosted Zone"
                },
                "Name": {
                    "Fn::Sub" : [
                        "${company}.dev.appframework.rocks",
                        { "company": {"Ref": "company"}}
                    ]
                }
            }
        }    
    },
    "Outputs": {
        "DNSZoneId": {
            "Condition" : "ConfRoute53",
            "Description": "DNS Hosted Zone ID",
            "Value": {"Ref": "DNSZone" }
        },
        "NGFWBootstrapBucket": {
            "Description" : "NGFW Bootstrap Bucket",
            "Value": { "Ref" : "NGFWBucket"}
        },
        "LabConfBucket": {
            "Description" : "Lab Configuration Bucket",
            "Value": { "Ref" : "ConfigBucket"}
        },
        "CreatedKeyPair": {
            "Description": "Created EC2 Key Pair",
            "Value": { "Fn::GetAtt": ["handleKeyPair", "keyPair"]}
        }
    }
}
